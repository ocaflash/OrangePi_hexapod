<?xml version="1.0"?>
<robot xmlns:xacro="http://ros.org/wiki/xacro" name="crab">

	<xacro:arg name="coxa_length" default="0.025" />
	<xacro:arg name="femur_length" default="0.077" />
	<xacro:arg name="tibia_length" default="0.120" />
	<xacro:arg name="joint_lower_limit" default="-1.5" />
	<xacro:arg name="joint_upper_limit" default="1.5" />
	<xacro:arg name="use_primitives" default="false" />

<!-- ============================================================================ -->
<!-- РАЗМЕРЫ ЗВЕНЬЕВ НОГИ (в метрах) -->
<!-- ============================================================================ -->
	<xacro:property name="coxa_length" value="${coxa_length}" />   <!-- 25 мм: ось coxa → ось femur -->
	<xacro:property name="femur_length" value="${femur_length}" />  <!-- 77 мм: ось femur → ось tibia -->
	<xacro:property name="tibia_length" value="${tibia_length}" />  <!-- 120 мм: ось tibia → кончик -->
	<!-- Суммарная длина ноги: 0.025 + 0.077 + 0.120 = 0.222 м -->

<!-- ============================================================================ -->
<!-- ГЕОМЕТРИЯ ТЕЛА -->
<!-- ============================================================================ -->
	<!-- Позиции крепления ног (leg_center) относительно центра тела -->
	<xacro:property name="body_front_x" value="0.087598" />
	<xacro:property name="body_side_y" value="0.050575" />
	<xacro:property name="body_mid_y" value="0.06985" />

<!-- Build the body frame -->
	<link name="base_link" />

	<joint name="base_joint" type="fixed">
		<parent link="base_link" />
		<child link="thorax" />
		<origin xyz="0 0 0" rpy="0 0 0" />
	</joint>			

	<link name="thorax">
    		<visual>
      			<origin	xyz="0 0 0" rpy="0 0 0" />
      			<geometry>
				<xacro:if value="${use_primitives}">
					<box size="0.18 0.12 0.04" />
				</xacro:if>
				<xacro:unless value="${use_primitives}">
					<mesh filename="package://crab_description/meshes/thorax.STL" />
				</xacro:unless>
      			</geometry>
     			<material name="grey">
        			<color rgba="0.5 0.5 0.5 1" />
      			</material>
    		</visual>
	</link>

<!-- Joint properties -->
	<xacro:property name="joint_lower_limit" value="${joint_lower_limit}" />
	<xacro:property name="joint_upper_limit" value="${joint_upper_limit}" />
	<xacro:property name="joint_effort" value="10000" />
	<xacro:property name="joint_velocity" value="100" />

<!-- Leg macros -->
	<xacro:macro name="leg" params="side num x y angle">

<!-- Build leg -->
  	<joint name="leg_center_joint_${side}${num}" type="fixed">
    		<origin xyz="${x} ${y} 0" rpy="0 0 0" /> 
    		<parent link="thorax" />
    		<child link="leg_center_${side}${num}" />
  	</joint>

    	<link name="leg_center_${side}${num}" />

	<joint name="coxa_joint_${side}${num}" type="revolute">
    		<origin xyz="0 0 0" rpy="0 0 ${angle}" />
    		<parent link="leg_center_${side}${num}" />
    		<child link="coxa_${side}${num}" />
    		<axis xyz="0 0 -1" />
    		<limit lower="${joint_lower_limit}" upper="${joint_upper_limit}" effort="${joint_effort}" velocity="${joint_velocity}" />
  	</joint>

  	<link name="coxa_${side}${num}">
    		<visual>
      			<origin xyz="0 0 0" rpy="0 0 0" />
      			<geometry>
					<xacro:if value="${use_primitives}">
						<box size="${coxa_length} 0.02 0.02" />
					</xacro:if>
					<xacro:unless value="${use_primitives}">
        				<mesh filename="package://crab_description/meshes/coxa_${side}.STL" />
					</xacro:unless>
      			</geometry>
      			<material name="">
        			<color rgba="0.7 0.7 0 1" />
      			</material>
    		</visual>
  	</link>

  	<joint name="femur_joint_${side}${num}" type="revolute">
    		<origin xyz="${coxa_length} 0 0" rpy="-${pi/2} 0 0" />
    		<parent link="coxa_${side}${num}" />
    		<child link="femur_${side}${num}" />
    		<axis xyz="0 0 -1" />
    		<limit lower="${joint_lower_limit}" upper="${joint_upper_limit}" effort="${joint_effort}" velocity="${joint_velocity}" />
  	</joint>

  	<link name="femur_${side}${num}">
    		<visual>
      			<origin xyz="0 0 0" rpy="0 0 0" />
      			<geometry>
					<xacro:if value="${use_primitives}">
						<box size="${femur_length} 0.02 0.02" />
					</xacro:if>
					<xacro:unless value="${use_primitives}">
        				<mesh filename="package://crab_description/meshes/femur_${side}.STL" />
					</xacro:unless>
      			</geometry>
      			<material name="">
        			<color rgba="0 0.7 0.7 1" />
      			</material>
    		</visual>
  	</link>

  	<joint name="tibia_joint_${side}${num}" type="revolute">
    		<origin xyz="${femur_length} 0 0" rpy="${pi} 0 ${pi/2}" />
    		<parent link="femur_${side}${num}" />
    		<child link="tibia_${side}${num}" />
    		<axis xyz="0 0 1" />
    		<limit lower="${joint_lower_limit}" upper="${joint_upper_limit}" effort="${joint_effort}" velocity="${joint_velocity}" />
  	</joint>

  	<link name="tibia_${side}${num}">
    		<visual>
      			<origin xyz="0 0 0" rpy="0 0 0.06" />
      			<geometry>
					<xacro:if value="${use_primitives}">
						<box size="${tibia_length} 0.02 0.02" />
					</xacro:if>
					<xacro:unless value="${use_primitives}">
       					<mesh filename="package://crab_description/meshes/tibia_${side}.STL" />
					</xacro:unless>
      			</geometry>
      			<material name="">
        			<color rgba="0.7 0 0.7 1" />
      			</material>
    		</visual>
  	</link>

  	<joint name="tibia_foot_joint_${side}${num}" type="fixed">
    		<origin xyz="${tibia_length} 0 0" rpy="0 0 0" />
    		<parent link="tibia_${side}${num}" />
    		<child link="tibia_foot_${side}${num}" />
  	</joint>

  	<link name="tibia_foot_${side}${num}" />
	</xacro:macro>

<!-- Build robot model -->
	<xacro:leg side="r" num="1" x="0.087598" 	y="-0.050575" 	angle="-${pi/3}" />
	<xacro:leg side="r" num="2" x="0" 		y="-0.06985" 	angle="-${pi/2}" />
	<xacro:leg side="r" num="3" x="-0.087598" 	y="-0.050575" 	angle="-${pi*2/3}" />
	<xacro:leg side="l" num="1" x="0.087598" 	y="0.050575"	angle="${pi/3}" />
	<xacro:leg side="l" num="2" x="0" 		y="0.06985"	angle="${pi/2}" />
	<xacro:leg side="l" num="3" x="-0.087598" 	y="0.050575" 	angle="${pi*2/3}" />
  
</robot>
